<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TOTPer Settings - Test</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 0; padding: 16px; background: #121212; color: #f5f5f5; }
    h1 { font-size: 24px; margin: 0 0 20px; text-align: center; }
    .entries { margin-bottom: 20px; }
    .entry { background: #1f1f1f; border-radius: 12px; padding: 16px; margin-bottom: 12px; display: flex; align-items: center; cursor: move; }
    .entry.dragging { opacity: 0.5; }
    .entry-content { flex: 1; }
    .entry-label { font-size: 16px; font-weight: bold; margin-bottom: 4px; }
    .entry-account { font-size: 14px; color: #9e9e9e; }
    .entry-remove { background: #f44336; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .add-section { background: #2c2c2c; border-radius: 12px; padding: 16px; margin-bottom: 20px; }
    .tabs { display: flex; margin-bottom: 16px; }
    .tab { background: #424242; color: #f5f5f5; border: none; padding: 12px 16px; cursor: pointer; border-radius: 8px 8px 0 0; }
    .tab.active { background: #4caf50; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; font-size: 14px; margin-bottom: 4px; color: #9e9e9e; }
    .form-group input { width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 16px; box-sizing: border-box; background: #1f1f1f; color: #f5f5f5; }
    .form-group textarea { width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 14px; box-sizing: border-box; background: #1f1f1f; color: #f5f5f5; min-height: 80px; font-family: monospace; }
    .qr-section { text-align: center; }
    .qr-result { margin-top: 12px; padding: 12px; background: #1f1f1f; border-radius: 8px; word-break: break-all; font-family: monospace; font-size: 12px; }
    button { border: none; border-radius: 8px; padding: 12px 16px; font-size: 16px; cursor: pointer; margin: 4px; }
    button.primary { background: #4caf50; color: white; }
    button.secondary { background: #424242; color: #f5f5f5; }
    button.danger { background: #f44336; color: white; }
    button:disabled { opacity: 0.45; cursor: not-allowed; }
    .actions { position: sticky; bottom: 0; display: flex; justify-content: space-between; gap: 8px; padding-top: 12px; background: rgba(18,18,18,0.95); margin: -16px; padding: 16px; }
    .hint { font-size: 13px; color: #b0bec5; margin-bottom: 16px; text-align: center; }
    .drag-handle { margin-right: 12px; color: #666; font-size: 18px; }
  </style>
</head>
<body>
  <h1>TOTPer</h1>
  <div id="entries" class="entries">
    <p class="hint">No entries yet. Add your first TOTP account below.</p>
  </div>

  <div class="add-section">
    <div class="tabs">
      <button class="tab active" data-tab="manual">Manual Entry</button>
      <button class="tab" data-tab="qr">QR Code</button>
    </div>

    <div id="manual" class="tab-content active">
      <div class="form-group">
        <label>Label</label>
        <input type="text" id="manual-label" placeholder="e.g. Google" maxlength="32">
      </div>
      <div class="form-group">
        <label>Account Name (optional)</label>
        <input type="text" id="manual-account" placeholder="e.g. user@gmail.com" maxlength="32">
      </div>
      <div class="form-group">
        <label>Secret (Base32)</label>
        <input type="text" id="manual-secret" placeholder="JBSWY3DPEHPK3PXP" maxlength="64">
      </div>
      <button id="add-manual" class="primary">Add Entry</button>
    </div>

    <div id="qr" class="tab-content">
      <div class="qr-section">
        <p>Paste otpauth URL from QR code:</p>
        <div class="form-group">
          <textarea id="qr-input" placeholder="otpauth://totp/..."></textarea>
        </div>
        <button id="parse-qr" class="primary">Parse & Add</button>
        <div id="qr-result" class="qr-result" style="display: none;"></div>
      </div>
    </div>
  </div>

  <div class="actions">
    <div>
      <button id="save" class="primary">Save</button>
      <button id="reset" class="danger">Clear All</button>
    </div>
    <button id="test-log" class="secondary">Test Log</button>
  </div>

  <script>
  (function() {
    console.log('[TOTPer] Test interface started');
    var entries = [];
    var draggedElement = null;

    function createEntryView(entry, index) {
      var container = document.createElement('div');
      container.className = 'entry';
      container.dataset.index = index;
      container.draggable = true;

      container.innerHTML = [
        '<span class="drag-handle">⋮⋮</span>',
        '<div class="entry-content">',
          '<div class="entry-label">' + (entry.label || 'Unnamed') + '</div>',
          '<div class="entry-account">' + (entry.account_name || '') + '</div>',
        '</div>',
        '<button type="button" class="entry-remove">×</button>'
      ].join('');

      container.querySelector('.entry-remove').addEventListener('click', function(e) {
        e.stopPropagation();
        entries.splice(index, 1);
        renderEntries();
      });

      container.addEventListener('dragstart', function(e) {
        draggedElement = container;
        container.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      });

      container.addEventListener('dragend', function(e) {
        container.classList.remove('dragging');
        draggedElement = null;
      });

      container.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
      });

      container.addEventListener('drop', function(e) {
        e.preventDefault();
        if (draggedElement && draggedElement !== container) {
          var draggedIndex = parseInt(draggedElement.dataset.index);
          var targetIndex = parseInt(container.dataset.index);

          var draggedEntry = entries.splice(draggedIndex, 1)[0];
          entries.splice(targetIndex, 0, draggedEntry);

          renderEntries();
        }
      });

      return container;
    }

    function renderEntries() {
      var entriesRoot = document.getElementById('entries');
      entriesRoot.innerHTML = '';
      if (!entries.length) {
        var empty = document.createElement('p');
        empty.className = 'hint';
        empty.textContent = 'No entries yet. Add your first TOTP account below.';
        entriesRoot.appendChild(empty);
      } else {
        entries.forEach(function(entry, idx) {
          entriesRoot.appendChild(createEntryView(entry, idx));
        });
      }
    }

    function parseOtpUri(text) {
      try {
        var url = new URL(text);
        if (url.protocol !== 'otpauth:') {
          throw new Error('Not an otpauth URL');
        }

        var type = url.hostname;
        if (type !== 'totp') {
          throw new Error('Only TOTP is supported');
        }

        var params = {};
        url.searchParams.forEach(function(value, key) {
          params[key.toLowerCase()] = value;
        });

        var label = decodeURIComponent(url.pathname.substring(1) || '');
        var issuer = params.issuer || '';

        var account = '';
        if (label.includes(':')) {
          var parts = label.split(':');
          if (!issuer) issuer = parts[0];
          account = parts.slice(1).join(':');
        } else {
          account = label;
        }

        var secret = (params.secret || '').toUpperCase().replace(/[^A-Z2-7]/g, '');
        var digits = parseInt(params.digits, 10) || 6;
        var period = parseInt(params.period, 10) || 30;

        if (!secret) {
          throw new Error('No secret found');
        }
        if (digits < 6 || digits > 8) {
          digits = 6;
        }
        if (period < 1 || period > 120) {
          period = 30;
        }

        return {
          label: issuer,
          account_name: account,
          secret: secret,
          period: period,
          digits: digits
        };
      } catch (err) {
        throw new Error('Invalid otpauth URL: ' + err.message);
      }
    }

    function switchTab(tabName) {
      var tabs = document.querySelectorAll('.tab');
      var contents = document.querySelectorAll('.tab-content');

      tabs.forEach(function(tab) {
        tab.classList.remove('active');
      });
      contents.forEach(function(content) {
        content.classList.remove('active');
      });

      document.querySelector('[data-tab="' + tabName + '"]').classList.add('active');
      document.getElementById(tabName).classList.add('active');
    }

    function addManualEntry() {
      var label = document.getElementById('manual-label').value.trim();
      var account = document.getElementById('manual-account').value.trim();
      var secret = document.getElementById('manual-secret').value.trim().toUpperCase().replace(/[^A-Z2-7]/g, '');

      if (!label || !secret) {
        alert('Label and Secret are required!');
        return;
      }

      entries.push({
        label: label,
        account_name: account,
        secret: secret,
        period: 30,
        digits: 6
      });

      document.getElementById('manual-label').value = '';
      document.getElementById('manual-account').value = '';
      document.getElementById('manual-secret').value = '';

      renderEntries();
    }

    function addQrEntry() {
      var qrText = document.getElementById('qr-input').value.trim();
      var resultDiv = document.getElementById('qr-result');

      if (!qrText) {
        alert('Please paste an otpauth URL!');
        return;
      }

      try {
        var entry = parseOtpUri(qrText);
        entries.push(entry);

        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '✓ Successfully added:<br>' +
          '<strong>' + entry.label + '</strong><br>' +
          (entry.account_name ? entry.account_name + '<br>' : '') +
          'Secret: ' + entry.secret.substring(0, 8) + '...<br>' +
          'Period: ' + entry.period + 's, Digits: ' + entry.digits;

        document.getElementById('qr-input').value = '';
        renderEntries();
      } catch (err) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '✗ Error: ' + err.message;
      }
    }

    // Tab switching
    document.querySelectorAll('.tab').forEach(function(tab) {
      tab.addEventListener('click', function() {
        switchTab(this.dataset.tab);
      });
    });

    document.getElementById('add-manual').addEventListener('click', addManualEntry);
    document.getElementById('parse-qr').addEventListener('click', addQrEntry);

    document.getElementById('save').addEventListener('click', function() {
      console.log('[TOTPer] Save button clicked');
      console.log('[TOTPer] Current entries:', entries);
      if (!entries.length) {
        alert('Add at least one entry first.');
        return;
      }
      alert('Configuration would be saved to watch!\\n\\n' + JSON.stringify(entries, null, 2));
    });

    document.getElementById('reset').addEventListener('click', function() {
      if (confirm('Delete all entries? This cannot be undone.')) {
        entries = [];
        renderEntries();
      }
    });

    document.getElementById('test-log').addEventListener('click', function() {
      console.log('[TOTPer] Test log button clicked');
      console.log('[TOTPer] Current entries:', entries);
      console.log('[TOTPer] Entries count:', entries.length);
    });

    renderEntries();
    console.log('[TOTPer] Test interface ready');
  })();
  </script>
</body>
</html>
